version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:18
    container_name: airline-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: airline_user
      POSTGRES_PASSWORD: airline_password
      POSTGRES_DB: airline_db
    volumes:
      - postgres:/var/lib/postgresql/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airline_user -d airline_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NestJS Server
  server:
    build:
      context: ./airline-server
      dockerfile: Dockerfile
    container_name: airline-server
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: airline_db
      DB_USER: airline_user
      DB_PASSWORD: airline_password
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./airline-server:/usr/src/server

  # React Web App
  web:
    build:
      context: ./airline-web
      dockerfile: Dockerfile
    container_name: airline-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      API_URL: http://localhost:3001
    depends_on:
      - server
    volumes:
      - ./airline-web:/usr/src/web

volumes:
  postgres: